<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game Statistics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .dashboard-header {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
        }
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .action-buttons {
            margin-top: 30px;
        }
        .username-display {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-speedometer2"></i> Game Statistics Dashboard</h1>
                    <p class="lead mb-0">Welcome back, <span class="username-display">{{ session["username"] }}</span></p>
                </div>
                <div class="col-md-4 text-end">
                    <img src="{{ avatar_url }}" width="100px" height="100px" alt="User Avatar" class="rounded-circle">
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div class="chart-container">
                    <h3><i class="bi bi-pie-chart-fill"></i> Game Performance</h3>
                    <div style="width: 100%; height: 400px;">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title"><i class="bi bi-trophy-fill"></i> Total Wins</h5>
                                <h2 class="mb-0">12</h2>
                                <p class="mb-0">+2 from last week</p>
                            </div>
                            <i class="bi bi-graph-up-arrow" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card stat-card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title"><i class="bi bi-emoji-frown-fill"></i> Total Losses</h5>
                                <h2 class="mb-0">8</h2>
                                <p class="mb-0">-1 from last week</p>
                            </div>
                            <i class="bi bi-graph-down-arrow" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card stat-card bg-secondary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title"><i class="bi bi-hand-thumbs-up-fill"></i> Win Rate</h5>
                                <h2 class="mb-0">60%</h2>
                                <p class="mb-0">5% improvement</p>
                            </div>
                            <i class="bi bi-percent" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-calendar-week"></i> Recent Activity</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Won against PlayerX
                                <span class="badge bg-success rounded-pill">Today</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Lost to PlayerY
                                <span class="badge bg-danger rounded-pill">Yesterday</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Drew with PlayerZ
                                <span class="badge bg-secondary rounded-pill">2 days ago</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Won against PlayerA
                                <span class="badge bg-success rounded-pill">3 days ago</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-award-fill"></i> Achievements</h5>
                        <div class="row">
                            <div class="col-4 text-center">
                                <i class="bi bi-trophy-fill" style="font-size: 2rem; color: gold;"></i>
                                <p class="mb-0">First Win</p>
                                <small class="text-muted">Unlocked</small>
                            </div>
                            <div class="col-4 text-center">
                                <i class="bi bi-hourglass-split" style="font-size: 2rem; color: silver;"></i>
                                <p class="mb-0">5 Streak</p>
                                <small class="text-muted">1 more win</small>
                            </div>
                            <div class="col-4 text-center">
                                <i class="bi bi-shield-lock" style="font-size: 2rem; color: #cd7f32;"></i>
                                <p class="mb-0">Defender</p>
                                <small class="text-muted">Locked</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-buttons d-flex justify-content-between">
            <div>
                <form method="GET" action="/change_password" class="d-inline">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-key-fill"></i> Change Password
                    </button>
                </form>
                <button class="btn btn-info me-2">
                    <i class="bi bi-gear-fill"></i> Settings
                </button>
            </div>
            <form method="POST" action="/logout" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('myChart');

        // get data from api
        // fetch('/api/v1/stats') with 1 argument, user_id

        

        let myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Win', 'Loss', 'Draw'],
                datasets: [{
                    data: [12, 8, 4],
                    backgroundColor: ["#008000", "#800000", "#808080"],
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Your Game Results',
                        font: {
                            size: 18
                        }
                    },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                },
                // Custom plugin to draw images
                plugins: {
                    afterDraw: (chart) => {
                        const { ctx, chartArea: { left, right, top, bottom, width, height } } = chart;
                        const centerX = (left + right) / 2;
                        const centerY = (top + bottom) / 2;
                        const radius = Math.min(width, height) / 2 * 0.6;

                        const meta = chart.getDatasetMeta(0);
                        meta.data.forEach((element, index) => {
                            const { startAngle, endAngle } = element;
                            const angle = startAngle + (endAngle - startAngle) / 2;
                            
                            const x = centerX + Math.cos(angle) * radius;
                            const y = centerY + Math.sin(angle) * radius;
                            const imgSize = radius * 0.4;

                            if (loadedImages[index]) {
                                ctx.save();
                                ctx.beginPath();
                                ctx.arc(x, y, imgSize / 2, 0, Math.PI * 2);
                                ctx.closePath();
                                ctx.clip();
                                
                                ctx.drawImage(
                                    loadedImages[index],
                                    x - imgSize / 2,
                                    y - imgSize / 2,
                                    imgSize,
                                    imgSize
                                );
                                ctx.restore();
                            }
                        });
                    }
                }
            }
        });
        stats = fetch("/api/v1/currentGame/stats?user_id="+"{{ session['user_id'] }}")
            .then(response => response.json())
            .then(data => {
                console.log(data);
                // Process data and update chart
                // Example: Update chart data with fetched data
                console.log(data.wins, data.losses, data.draws);
                myChart.data.datasets[0].data = [data.wins, data.losses, data.draws];
                myChart.update();
            })
            .catch(error => console.error('Error fetching stats:', error));
    </script>
</body>

</html>